{% extends 'Base_admin.html' %}

{% block title %}
    Admin Dashboard
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4">Admin Dashboard</h1>

    <div class="card mb-4" style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
        <h3>Total Registered Users: {{ total_users }}</h3>
    </div>

    <h2>Users</h2>
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Name</th>
                <th>Email</th>
                <th>Gender</th>
                <th>Age</th>
                <th>Contact</th>
                <th>Is Admin</th>
                <th>Is Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.gender }}</td>
                <td>{{ user.age }}</td>
                <td>{{ user.contact }}</td>
                <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                <td>{{ 'Yes' if user.is_active else 'No' }}</td>
                <td>
                    {% if user.is_active %}
                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm">
                            Deactivate
                        </button>
                    </form>
                    {% else %}
                        <span class="text-muted">Inactive</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <hr>

    <h2>Health Records</h2>

    <form action="{{ url_for('admin.admin_dashboard') }}" method="POST" class="mb-4">
    <div class="row">
        <div class="col-md-3">
            <label for="user_id"><strong>Select User:</strong></label>
            <select name="user_id" id="user_id" class="form-control" required>
                <option value="all">All Users</option>
                {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }} (ID: {{ user.id }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label for="start_date"><strong>Start Date:</strong></label>
            <input type="date" class="form-control" name="start_date" id="start_date">
        </div>

        <div class="col-md-2">
            <label for="end_date"><strong>End Date:</strong></label>
            <input type="date" class="form-control" name="end_date" id="end_date">
        </div>

        <div class="col-md-2">
            <label for="filter_field"><strong>Filter By:</strong></label>
            <select name="filter_field" class="form-control">
                <option value="">-- None --</option>
                <option value="heart_rate">Heart Rate</option>
                <option value="blood_pressure">Blood Pressure</option>
                <option value="oxygen_saturation">Oxygen Saturation</option>
                <option value="stress_level">Stress Level</option>
                <option value="sleep_hours">Sleep Hours</option>
                <option value="calories_burned">Calories Burned</option>
            </select>
        </div>

        <div class="col-md-1">
            <label><strong>Condition</strong></label>
            <select name="filter_condition" class="form-control">
                <option value="">--</option>
                <option value=">">></option>
                <option value="<"><</option>
                <option value="=">=</option>
            </select>
        </div>

        <div class="col-md-2">
            <label><strong>Value</strong></label>
            <input type="number" step="any" name="filter_value" class="form-control">
        </div>
        </div>
        <div class="col-md-3">
        <input type="hidden" name="download" id="download" value="no">
        <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
        <button type="submit" class="btn btn-success mt-3" onclick="document.getElementById('download').value='yes';">
        Download CSV
        </button>
        </div>

    </div>
</form>
{% if records %}
    <p class="text-muted">Found {{ records|length }} matching health record(s).</p>
{% else %}
    <p class="text-muted">No records match your filter criteria.</p>
{% endif %}


    {% if records %}
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>User ID</th>
                <th>Heart Rate</th>
                <th>Blood Pressure</th>
                <th>Oxygen Saturation</th>
                <th>Stress Level</th>
                <th>Sleep Hours</th>
                <th>Calories Burned</th>
                <th>Recorded At</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>{{ record.user_id }}</td>
                <td>{{ record.heart_rate }}</td>
                <td>{{ record.blood_pressure }}</td>
                <td>{{ record.oxygen_saturation }}%</td>
                <td>{{ record.stress_level }}</td>
                <td>{{ record.sleep_hours }}</td>
                <td>{{ record.calories_burned }}</td>
                <td>{{ record.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">No health records found for the selected user.</p>
    {% endif %}
</div>
{% endblock %}
